<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ephemeral</title>
</head>
<body style="overflow:hidden;margin:0;padding:0;">
<h1>Ephemeral</h1>
<p>The short-lived social network</p>

<h2>Recent shares</h2>
<ol id="shares">
</ol>
<textarea id="dump" rows="20"></textarea>
<map id="map">
  <area shape="rect" coords="0,0,119,150" href="javascript:navigator.mozSocial.openChatWindow('/chat1.html')" />
  <area shape="rect" coords="119,0,249,150" href="javascript:navigator.mozSocial.openChatWindow('/chat2.html')" />
  <area shape="rect" coords="0,150,119,296" href="javascript:navigator.mozSocial.openChatWindow('/chat3.html')" />
  <area shape="rect" coords="119,150,249,296" href="javascript:navigator.mozSocial.openChatWindow('/chat4.html')" />
</map>
<img src="people.jpg" usemap="#map" style="position:absolute;bottom:0;left:0;" />
<script src="/socket.io/socket.io.js"></script>
<script type="application/javascript;version=1.8">
port = navigator.mozSocial.getWorker().port;
port.postMessage({topic: 'sidebar.registration'});

function dump(msg) {
  let d = document.getElementById("dump");
  d.textContent = msg + '\n' + d.textContent;
}

let socket = new io.connect(window.location.hostname);
socket.on('news', function (data) {
  console.log(data);
  socket.emit('my other event', { my: 'data' });
});

socket.on('ambient-update', function(data) {
  dump("got ambient-update (sidebar)");
  port.postMessage({topic: 'ambient-update', data: data});
});

socket.on('newsfeed-update', function(data) {
  let s = document.getElementById("shares");
  dump("got newsfeed-udpate (sidebar)");
  let messages = JSON.parse(data.news);
  s.innerHTML = '';
  for (let i = 0; i < messages.length; i++) {
    let li = document.createElement('li');
    let a = document.createElement('a');
    a.setAttribute("href", messages[i]);
    a.textContent = messages[i];
    li.appendChild(a);
    s.appendChild(li);
  }
});

socket.on('chat1-message-response', function(data) {
  port.postMessage({topic: 'chat1-message-response', data: data});
});

port.onmessage = function(e) {
  let data = e.data;
  dump("Got topic: " + data.topic);

  switch (data.topic) {
    case "share":
      dump("with url: " + data.data.url);
      socket.emit('share', {url: data.data.url});
      break;
    case "unshare":
      dump("with url: " + data.data.url);
      socket.emit('unshare', {url: data.data.url});
      break;
    case "chat1-message":
      for (var i in data)
        dump(i + data[i]);
      dump("with message: " + data.data.message);
      socket.emit('chat1-message', data.data.message);
      break;
    case "dump":
      dump(data.message);
      break;
    default:
      dump("UNHANDLED TOPIC, " + data.topic);
  }
};

</script>
</body>
</html>
